SchemaVersion: 2018-07-01
Owner: "@10gen/sql-engines-team"
Description: |
  This workload uses the RunCommand actor to issue an aggregation pipeline,
  generated by translating TPC-H query 9 via MongoDB BIC
q9_normalized:
  Repeat: 1
  Database: tpch
  Operations:
    - OperationMetricsName: BIC
      OperationName: RunCommand
      OperationCommand:
        aggregate: part
        pipeline:
          [
            {
              "$match":
                {
                  "$and":
                    [
                      { "p_partkey": { "$ne": null } },
                      { "p_name": { "$regex": "^.*pink.*$", "$options": "si" } },
                    ],
                },
            },
            {
              "$lookup":
                {
                  "from": "lineitem",
                  "localField": "p_partkey",
                  "foreignField": "l_partkey",
                  "as": "__joined_lineitem",
                },
            },
            { "$unwind": "$__joined_lineitem" },
            {
              "$match":
                {
                  "$and":
                    [
                      { "__joined_lineitem.l_suppkey": { "$ne": null } },
                      { "$expr": { "$gt": ["$__joined_lineitem.l_partkey", null] } },
                      { "__joined_lineitem.l_suppkey": { "$ne": null } },
                      { "__joined_lineitem.l_orderkey": { "$ne": null } },
                    ],
                },
            },
            {
              "$lookup":
                {
                  "from": "orders",
                  "localField": "__joined_lineitem.l_orderkey",
                  "foreignField": "o_orderkey",
                  "as": "__joined_orders",
                },
            },
            { "$unwind": "$__joined_orders" },
            {
              "$lookup":
                {
                  "from": "partsupp",
                  "localField": "__joined_lineitem.l_suppkey",
                  "foreignField": "ps_suppkey",
                  "as": "__joined_partsupp",
                },
            },
            { "$unwind": "$__joined_partsupp" },
            {
              "$match":
                {
                  "$expr":
                    {
                      "$and":
                        [
                          { "$gt": ["$__joined_partsupp.ps_partkey", null] },
                          {
                            "$eq":
                              [
                                "$__joined_partsupp.ps_partkey",
                                "$__joined_lineitem.l_partkey",
                              ],
                          },
                        ],
                    },
                },
            },
            {
              "$lookup":
                {
                  "from": "supplier",
                  "localField": "__joined_lineitem.l_suppkey",
                  "foreignField": "s_suppkey",
                  "as": "__joined_supplier",
                },
            },
            { "$unwind": "$__joined_supplier" },
            { "$match": { "__joined_supplier.s_nationkey": { "$ne": null } } },
            {
              "$lookup":
                {
                  "from": "nation",
                  "localField": "__joined_supplier.s_nationkey",
                  "foreignField": "n_nationkey",
                  "as": "__joined_nation",
                },
            },
            { "$unwind": "$__joined_nation" },
            {
              "$project":
                {
                  "tpch_DOT_nation_DOT_n_name": "$__joined_nation.n_name",
                  "extract(year,tpch_DOT_orders_DOT_o_orderdate)":
                    {
                      "$cond":
                        {
                          "if":
                            {
                              "$lte":
                                ["$__joined_orders.o_orderdate", { "$literal": null }],
                            },
                          "then": { "$literal": null },
                          "else": { "$year": "$__joined_orders.o_orderdate" },
                        },
                    },
                  "tpch_DOT_lineitem_DOT_l_extendedprice*1-tpch_DOT_lineitem_DOT_l_discount-tpch_DOT_partsupp_DOT_ps_supplycost*tpch_DOT_lineitem_DOT_l_quantity":
                    {
                      "$subtract":
                        [
                          {
                            "$multiply":
                              [
                                "$__joined_lineitem.l_extendedprice",
                                {
                                  "$subtract":
                                    [
                                      { "$literal": 1 },
                                      "$__joined_lineitem.l_discount",
                                    ],
                                },
                              ],
                          },
                          {
                            "$multiply":
                              [
                                "$__joined_partsupp.ps_supplycost",
                                "$__joined_lineitem.l_quantity",
                              ],
                          },
                        ],
                    },
                },
            },
            {
              "$group":
                {
                  "_id":
                    {
                      "group_key_0":
                        {
                          "$ifNull":
                            ["$tpch_DOT_nation_DOT_n_name", { "$literal": null }],
                        },
                      "group_key_1":
                        {
                          "$ifNull":
                            [
                              "$extract(year,tpch_DOT_orders_DOT_o_orderdate)",
                              { "$literal": null },
                            ],
                        },
                    },
                  "sum(tpch_DOT_profit_DOT_amount)":
                    {
                      "$sum": "$tpch_DOT_lineitem_DOT_l_extendedprice*1-tpch_DOT_lineitem_DOT_l_discount-tpch_DOT_partsupp_DOT_ps_supplycost*tpch_DOT_lineitem_DOT_l_quantity",
                    },
                  "sum(tpch_DOT_profit_DOT_amount)_count":
                    {
                      "$sum":
                        {
                          "$cond":
                            {
                              "if":
                                {
                                  "$lte":
                                    [
                                      "$tpch_DOT_lineitem_DOT_l_extendedprice*1-tpch_DOT_lineitem_DOT_l_discount-tpch_DOT_partsupp_DOT_ps_supplycost*tpch_DOT_lineitem_DOT_l_quantity",
                                      null,
                                    ],
                                },
                              "then": 0,
                              "else": 1,
                            },
                        },
                    },
                },
            },
            {
              "$project":
                {
                  "_id": 0,
                  "tpch_DOT_profit_DOT_nation": "$_id.group_key_0",
                  "tpch_DOT_profit_DOT_o_year": "$_id.group_key_1",
                  "sum(tpch_DOT_profit_DOT_amount)":
                    {
                      "$cond":
                        {
                          "if": "$sum(tpch_DOT_profit_DOT_amount)_count",
                          "then": "$sum(tpch_DOT_profit_DOT_amount)",
                          "else": { "$literal": null },
                        },
                    },
                },
            },
            {
              "$sort":
                {
                  "tpch_DOT_profit_DOT_nation": 1,
                  "tpch_DOT_profit_DOT_o_year": -1,
                },
            },
            {
              "$project":
                {
                  "tpch_DOT_profit_DOT_nation": "$tpch_DOT_profit_DOT_nation",
                  "tpch_DOT_profit_DOT_o_year": "$tpch_DOT_profit_DOT_o_year",
                  "tpch_DOT_sum(tpch_DOT_profit_DOT_amount)": "$sum(tpch_DOT_profit_DOT_amount)",
                  "_id": 0,
                },
            },
          ]
        cursor: {}

SchemaVersion: 2018-07-01
Owner: "@10gen/sql-engines-team"
Description: |
  This workload uses the RunCommand actor to issue an aggregation pipeline,
  generated by translating TPC-H query 3 via MongoDB BIC
q3_normalized:
  Repeat: 1
  Database: tpch
  Operations:
    - OperationMetricsName: BIC
      OperationName: RunCommand
      OperationCommand:
        aggregate: lineitem
        pipeline:
          [
            {
              "$match":
                {
                  "$and":
                    [
                      { "l_orderkey": { "$ne": null } },
                      { "l_shipdate": { "$gt": ISODate("1995-03-15T00:00:00") } },
                    ],
                },
            },
            {
              "$lookup":
                {
                  "from": "orders",
                  "localField": "l_orderkey",
                  "foreignField": "o_orderkey",
                  "as": "__joined_orders",
                },
            },
            { "$unwind": "$__joined_orders" },
            {
              "$match":
                {
                  "$and":
                    [
                      { "__joined_orders.o_custkey": { "$ne": null } },
                      {
                        "__joined_orders.o_orderdate":
                          { "$lt": ISODate("1995-03-01T00:00:00") },
                      },
                    ],
                },
            },
            {
              "$lookup":
                {
                  "from": "customer",
                  "localField": "__joined_orders.o_custkey",
                  "foreignField": "c_custkey",
                  "as": "__joined_customer",
                },
            },
            { "$unwind": "$__joined_customer" },
            { "$match": { "__joined_customer.c_mktsegment": { "$eq": "BUILDING" } } },
            {
              "$group":
                {
                  "_id":
                    {
                      "group_key_0": { "$ifNull": ["$l_orderkey", { "$literal": null }] },
                      "group_key_1":
                        {
                          "$ifNull":
                            ["$__joined_orders.o_orderdate", { "$literal": null }],
                        },
                      "group_key_2":
                        {
                          "$ifNull":
                            ["$__joined_orders.o_shippriority", { "$literal": null }],
                        },
                    },
                  "sum(tpch_DOT_lineitem_DOT_l_extendedprice*1-tpch_DOT_lineitem_DOT_l_discount)":
                    {
                      "$sum":
                        {
                          "$multiply":
                            [
                              "$l_extendedprice",
                              { "$subtract": [1, "$l_discount"] },
                            ],
                        },
                    },
                  "sum(tpch_DOT_lineitem_DOT_l_extendedprice*1-tpch_DOT_lineitem_DOT_l_discount)_count":
                    {
                      "$sum":
                        {
                          "$cond":
                            {
                              "if":
                                {
                                  "$lte":
                                    [
                                      {
                                        "$multiply":
                                          [
                                            "$l_extendedprice",
                                            {
                                              "$subtract":
                                                [1, "$l_discount"],
                                            },
                                          ],
                                      },
                                      null,
                                    ],
                                },
                              "then": 0,
                              "else": 1,
                            },
                        },
                    },
                },
            },
            {
              "$project":
                {
                  "_id": 0,
                  "tpch_DOT_lineitem_DOT_l_orderkey": "$_id.group_key_0",
                  "tpch_DOT_orders_DOT_o_orderdate": "$_id.group_key_1",
                  "tpch_DOT_orders_DOT_o_shippriority": "$_id.group_key_2",
                  "sum(tpch_DOT_lineitem_DOT_l_extendedprice*1-tpch_DOT_lineitem_DOT_l_discount)":
                    {
                      "$cond":
                        {
                          "if": "$sum(tpch_DOT_lineitem_DOT_l_extendedprice*1-tpch_DOT_lineitem_DOT_l_discount)_count",
                          "then": "$sum(tpch_DOT_lineitem_DOT_l_extendedprice*1-tpch_DOT_lineitem_DOT_l_discount)",
                          "else": { "$literal": null },
                        },
                    },
                },
            },
            {
              "$sort":
                {
                  "sum(tpch_DOT_lineitem_DOT_l_extendedprice*1-tpch_DOT_lineitem_DOT_l_discount)": -1,
                  "tpch_DOT_orders_DOT_o_orderdate": 1,
                },
            },
            {
              "$project":
                {
                  "tpch_DOT_lineitem_DOT_l_orderkey": "$tpch_DOT_lineitem_DOT_l_orderkey",
                  "tpch_DOT_sum(tpch_DOT_lineitem_DOT_l_extendedprice*1-tpch_DOT_lineitem_DOT_l_discount)": "$sum(tpch_DOT_lineitem_DOT_l_extendedprice*1-tpch_DOT_lineitem_DOT_l_discount)",
                  "tpch_DOT_orders_DOT_o_orderdate": "$tpch_DOT_orders_DOT_o_orderdate",
                  "tpch_DOT_orders_DOT_o_shippriority": "$tpch_DOT_orders_DOT_o_shippriority",
                  "_id": 0,
                },
            },
          ]
        cursor: {}
